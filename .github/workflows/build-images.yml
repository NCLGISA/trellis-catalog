name: Build Bridge Images

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      bridges: ${{ steps.detect.outputs.bridges }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect bridges with version changes
        id: detect
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            BRIDGES=$(ls -d bridges/*/ 2>/dev/null | xargs -I{} basename {} | tr '\n' ' ')
          else
            BRIDGES=$(git diff "$PREV_TAG" HEAD --name-only \
              | grep '^bridges/' \
              | cut -d'/' -f2 \
              | sort -u \
              | tr '\n' ' ')
          fi

          if [ -z "$BRIDGES" ]; then
            echo "No bridge changes detected"
            echo "bridges=" >> "$GITHUB_OUTPUT"
          else
            echo "Changed bridges: $BRIDGES"
            MATRIX=$(echo "$BRIDGES" | tr ' ' '\n' | grep -v '^$' | jq -Rnc '[inputs]')
            echo "bridges=$MATRIX" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.bridges != '' && needs.detect-changes.outputs.bridges != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bridge: ${{ fromJson(needs.detect-changes.outputs.bridges) }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from bridge.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' "bridges/${{ matrix.bridge }}/bridge.yaml" | head -1 | sed 's/version: *["]*//;s/["]*$//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Bridge: ${{ matrix.bridge }}, Version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: bridges/${{ matrix.bridge }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/nclgisa/bridge-${{ matrix.bridge }}:${{ steps.version.outputs.version }}
            ghcr.io/nclgisa/bridge-${{ matrix.bridge }}:latest
          cache-from: type=gha,scope=bridge-${{ matrix.bridge }}
          cache-to: type=gha,mode=max,scope=bridge-${{ matrix.bridge }}

  summary:
    needs: [detect-changes, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build summary
        run: |
          echo "## Bridge Image Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Tag: ${{ github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Bridges built: ${{ needs.detect-changes.outputs.bridges }}" >> "$GITHUB_STEP_SUMMARY"
