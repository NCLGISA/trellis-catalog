name: Validate Bridges

on:
  pull_request:
    paths:
      - "bridges/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed bridges
        id: changed
        run: |
          BRIDGES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} \
            | grep '^bridges/' \
            | cut -d'/' -f2 \
            | sort -u)
          echo "bridges=$BRIDGES" >> "$GITHUB_OUTPUT"
          echo "Changed bridges: $BRIDGES"

      - name: Validate bridge.yaml presence
        run: |
          EXIT=0
          for bridge in ${{ steps.changed.outputs.bridges }}; do
            echo "--- Checking $bridge ---"
            if [ ! -f "bridges/$bridge/bridge.yaml" ]; then
              echo "ERROR: bridges/$bridge/bridge.yaml is missing"
              EXIT=1
            fi
          done
          exit $EXIT

      - name: Validate required manifest fields
        run: |
          EXIT=0
          for bridge in ${{ steps.changed.outputs.bridges }}; do
            MANIFEST="bridges/$bridge/bridge.yaml"
            [ -f "$MANIFEST" ] || continue
            for field in name version description; do
              if ! grep -q "^${field}:" "$MANIFEST"; then
                echo "ERROR: $MANIFEST missing required field: $field"
                EXIT=1
              fi
            done
            if ! grep -q "type:" "$MANIFEST"; then
              echo "ERROR: $MANIFEST missing deployment.type"
              EXIT=1
            fi
          done
          exit $EXIT

      - name: Check entrypoint permissions (container bridges)
        run: |
          EXIT=0
          for bridge in bridges/*/; do
            EP="$bridge/entrypoint.sh"
            if [ -f "$EP" ] && [ ! -x "$EP" ]; then
              echo "ERROR: $EP is not executable (chmod +x required)"
              EXIT=1
            fi
          done
          exit $EXIT

      - name: Validate SKILL.md frontmatter
        run: |
          EXIT=0
          for skill in bridges/*/skills/*/SKILL.md; do
            [ -f "$skill" ] || continue
            if ! head -1 "$skill" | grep -q '^---'; then
              echo "ERROR: $skill missing YAML frontmatter"
              EXIT=1
            fi
          done
          exit $EXIT

      - name: Sanitization check
        run: |
          EXIT=0
          PATTERNS="rowancountync\.gov|10\.1\.[0-9]|192\.168\.[0-9]|\.internal\.|AKIAIOSFODNN7EXAMPLE"
          for bridge in bridges/*/; do
            if grep -rEi "$PATTERNS" "$bridge" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.md" --include="*.sh" --include="*.ps1"; then
              echo "ERROR: Organization-specific content found in $bridge"
              EXIT=1
            fi
          done
          exit $EXIT

      - name: Validate CalVer version format
        run: |
          EXIT=0
          for bridge in ${{ steps.changed.outputs.bridges }}; do
            MANIFEST="bridges/$bridge/bridge.yaml"
            [ -f "$MANIFEST" ] || continue
            VERSION=$(grep '^version:' "$MANIFEST" | head -1 | sed 's/version: *["]*//;s/["]*$//')
            if ! echo "$VERSION" | grep -qE '^[0-9]{4}\.[0-9]{2}\.[0-9]{2}\.[0-9]+$'; then
              echo "ERROR: $bridge version '$VERSION' is not CalVer (YYYY.MM.DD.MICRO)"
              EXIT=1
            fi
          done
          exit $EXIT
